================================================================================
PULSE FETCH - OAUTH & AUTHENTICATION EXPLORATION FINDINGS
================================================================================

QUICK SUMMARY
=============

STATUS: OAuth is NOT implemented
- Remote HTTP server has a placeholder auth middleware with no logic
- All authentication checking is a no-op passthrough
- Server accepts requests from ANY client without validation

WHAT EXISTS:
- CORS configuration (configurable origin whitelist)
- DNS rebinding protection (production only)
- Session management (cryptographically secure UUIDs)
- Health checks for external API keys (Firecrawl, etc.)

WHAT'S MISSING:
- No client authentication mechanism
- No request validation
- No rate limiting
- No per-request authentication


FILE LOCATIONS
==============

PLACEHOLDER AUTH MIDDLEWARE
  /home/jmagar/code/pulse-crawl/remote/src/middleware/auth.ts
  - Line 17: authMiddleware() function
  - Comment says "TODO: Implement authentication logic"
  - Currently just calls next() without any checks

EXPRESS SERVER (NOT USING AUTH)
  /home/jmagar/code/pulse-crawl/remote/src/server.ts
  - Line 7: Imports auth middleware
  - Line 22-23: Uses express.json() and CORS
  - NOT REGISTERED: authMiddleware is imported but never app.use()'d

TRANSPORT & SESSIONS
  /home/jmagar/code/pulse-crawl/remote/src/transport.ts
  - Lines 50-65: StreamableHTTPServerTransport configuration
  - Line 51: Uses randomUUID() for session IDs (secure)
  - Lines 62-63: ALLOWED_HOSTS and ALLOWED_ORIGINS for DNS protection

SERVER STARTUP
  /home/jmagar/code/pulse-crawl/remote/src/index.ts
  - Line 3: Loads .env with dotenv
  - Lines 22-31: Logs available services based on env vars
  - Lines 48-67: Runs health checks on external API keys
  - Line 71: Starts Express server on port 3060

CONFIGURATION
  /home/jmagar/code/pulse-crawl/.env.example
  - External service API keys (Firecrawl, Anthropic, OpenAI)
  - Server config: PORT, NODE_ENV, ALLOWED_ORIGINS, ALLOWED_HOSTS
  - Feature flags: ENABLE_RESUMABILITY, SKIP_HEALTH_CHECKS

TESTS
  /home/jmagar/code/pulse-crawl/tests/remote/middleware.test.ts
  - Tests that auth middleware is a no-op
  - Tests CORS configuration parsing
  - Tests health endpoint


ENVIRONMENT VARIABLES
=====================

CURRENTLY RECOGNIZED:
  FIRECRAWL_API_KEY           - External service (web scraping)
  ANTHROPIC_API_KEY           - External service (LLM extraction)
  OPENAI_API_KEY              - External service (LLM extraction)
  PORT                        - Server port (default: 3060)
  NODE_ENV                    - Environment (development/production)
  ALLOWED_ORIGINS             - CORS whitelist (comma-separated)
  ALLOWED_HOSTS               - DNS protection whitelist
  ENABLE_RESUMABILITY         - Session resumability (true/false)
  SKIP_HEALTH_CHECKS          - Skip startup checks (true/false)

NO AUTHENTICATION VARIABLES:
  - No OAuth provider configuration
  - No JWT secret
  - No API key for client validation
  - No rate limiting config


SECURITY ASSESSMENT
===================

CURRENT PROTECTIONS:
  ✓ CORS with configurable origins
  ✓ DNS rebinding protection (production)
  ✓ Secure session ID generation (UUID v4)
  ✓ Health checks for service availability

MISSING PROTECTIONS:
  ✗ No client authentication
  ✗ No request validation
  ✗ No rate limiting
  ✗ No per-request API key checking
  ✗ No HTTPS enforcement (must be reverse proxy)
  ✗ No audit logging


ARCHITECTURE
============

Three-Layer Design:
  1. shared/  - Core business logic (used by both local & remote)
  2. local/   - Stdio transport (Claude Desktop integration)
  3. remote/  - HTTP streaming transport (this needs auth)

MCP Protocol:
  - Version: 2025-03-26
  - Transport: StreamableHTTPServerTransport (HTTP POST with JSON + optional SSE)
  - Session Headers: mcp-session-id, Last-Event-ID

Session Management:
  - Location: In-memory map in Express server
  - ID format: UUID v4 (36 characters)
  - Storage: Lost on restart (no persistence)
  - Resumability: Optional (via InMemoryEventStore)


HOW IT CURRENTLY WORKS
======================

Request Flow (No Auth):
  1. Client sends HTTP request to /mcp
  2. Server checks mcp-session-id header
  3. Auth middleware: SKIPPED (not registered)
  4. CORS check: Applied
  5. Handle request with transport
  6. Return response


REQUEST/RESPONSE EXAMPLE
=======================

Initialize Session:
  POST /mcp
  Content-Type: application/json

  {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2025-03-26",
      "clientInfo": {
        "name": "my-client",
        "version": "1.0.0"
      }
    }
  }

Response (includes session ID):
  {
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
      "protocolVersion": "2025-03-26",
      "serverInfo": {
        "name": "pulse-crawl",
        "version": "0.3.0"
      },
      "capabilities": { ... }
    }
  }

  Headers:
    Mcp-Session-Id: <UUID-v4>


IMPLEMENTATION OPTIONS
======================

For OAuth 2.0 Implementation:
  1. Define OAuth provider (Google, GitHub, or custom)
  2. Add environment variables:
     - OAUTH_PROVIDER
     - OAUTH_CLIENT_ID
     - OAUTH_CLIENT_SECRET
     - OAUTH_CALLBACK_URL
  3. Install dependencies:
     - jsonwebtoken (JWT handling)
     - passport-oauth2 (OAuth strategy)
  4. Implement auth middleware in remote/src/middleware/auth.ts
  5. Register middleware in Express app
  6. Add tests to verify authentication

For API Key Implementation:
  1. Add environment variable: MCP_API_KEY
  2. Validate Authorization header in auth middleware
  3. Check against environment variable
  4. Return 401 if invalid

For JWT Implementation:
  1. Add environment variable: JWT_SECRET
  2. Validate Bearer token in Authorization header
  3. Verify signature using JWT_SECRET
  4. Extract claims for audit logging


DEPENDENCIES AVAILABLE
======================

Already Installed:
  - express@5.0.0
  - cors@2.8.17
  - dotenv@16.4.5
  - @modelcontextprotocol/sdk@1.19.1

Can Be Added:
  - jsonwebtoken (JWT tokens)
  - passport (authentication middleware)
  - passport-oauth2 (OAuth strategies)
  - express-rate-limit (rate limiting)
  - helmet (security headers)


PRODUCTION CHECKLIST (FROM README)
==================================

Current Status:
  [✓] Set NODE_ENV=production
  [✓] Configure ALLOWED_ORIGINS to specific domains
  [✓] Configure ALLOWED_HOSTS to your server's domain
  [✗] Use HTTPS (requires reverse proxy)
  [ ] Implement authentication middleware in middleware/auth.ts  <- TODO
  [✓] Use environment-specific API keys
  [ ] Enable rate limiting at reverse proxy level  <- TODO
  [✓] Monitor logs and health endpoint
  [ ] Implement persistent event store for resumability  <- TODO


RECOMMENDATIONS
===============

1. Define Authentication Strategy
   - Choose between OAuth 2.0, JWT, or API keys
   - Consider MCP SDK authentication helpers
   - Plan for multi-instance deployment if needed

2. Update Environment Variables
   - Add authentication configuration
   - Document in .env.example
   - Add validation in index.ts

3. Implement Auth Middleware
   - Update remote/src/middleware/auth.ts
   - Register in Express app (server.ts)
   - Add error handling for invalid requests

4. Add Comprehensive Tests
   - Test successful authentication
   - Test failed authentication
   - Test invalid tokens/keys
   - Test rate limiting (if implemented)

5. Update Documentation
   - Document authentication setup
   - Add security guidelines
   - Add troubleshooting section

6. Deploy Securely
   - Use HTTPS (reverse proxy)
   - Implement rate limiting
   - Monitor for abuse
   - Log authentication attempts


CONCLUSION
==========

The pulse-crawl remote HTTP server currently has NO authentication implemented.
The auth middleware is a non-functional placeholder that requires implementation
before production deployment.

An explicit TODO in the production checklist (item 5) confirms this is planned
but not yet completed.

The recommended next step is to define an authentication strategy and implement
it in the auth middleware before deploying to production.

================================================================================
